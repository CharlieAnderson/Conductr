<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <title>
      Mozilla Labs : TogetherJS
    </title>
    <meta name="viewport" content="width=320, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <meta name="description" content="Real time collaboration features for your website or app.">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../images/fav-icon.ico">

    <!-- use this block to set togetherjs config -->
    

    <script src="../js/jquery-1.10.2.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/parallax.js"></script>
    <script src="../js/custom.js"></script>
    <script src="../js/scrollTo.js"></script>
    <script src="../js/scrollspy.js"></script>
    <script src="../js/waypoints.min.js"></script>
    <script src="../js/how-animations.js"></script>
    <script src="../togetherjs.js"></script>

    <!-- retina library -->
    <script src="../js/retina.js"></script>

    <script src="//mozorg.cdn.mozilla.net/tabzilla/tabzilla.js"></script>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-35433268-28']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>

    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.css" rel="stylesheet">
    <link href="../css/jumbotron.css" rel="stylesheet">
    <link href="../css/carousel.css" rel="stylesheet">
    <link href="../css/grid.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <link href="//mozorg.cdn.mozilla.net/media/css/tabzilla-min.css" rel="stylesheet" />

    
  <link rel="stylesheet" href="../css/docco.css">
  <script src="../js/source-code.js"></script>


    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js">
      </script>
    <![endif]-->
    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="../assets/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-35433268-43', 'togetherjs.com');
    ga('send', 'pageview');
    </script>

  </head>
  <body >
    <div class="navbar main-header" id="main-navbar">

      <!-- Tabzilla -->
      <a href="https://www.mozilla.org/" id="tabzilla">mozilla</a>

      <!-- start container -->
      <div class="container navbox">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand main-logo" href=".././"></a>
          <a class="navbar-brand masthead-title" href=".././">TogetherJS</a>
        </div>

        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right main-nav">
            <li><a href=".././"  >Overview</a></li>
            <li><a class="documentationActive"href=".././docs/"  >Documentation</a></li>
            <li><a href="https://github.com/mozilla/togetherjs" target="_blank">Github</a></li>
            <li><a href="mailto:togetherjs@mozilla.com">Contact</a></li>
          </ul>
        </div><!--/.navbar-collapse -->

      </div>
    </div>


    

<div class="container">

    <section class="row" id="sourcecode">
      <div class="col-md-3" id="source-toc">
        <div class="panel" role="complementary" data-spy="affix" data-offset-top="200" id="sidenav">
          <div class="panel-heading">Source Code</div>
          <ul class="nav" id="sectionmenu">
            
              <li><a href="analytics.js.html">analytics</a></li>
            
              <li><a href="channels.js.html">channels</a></li>
            
              <li><a href="chat.js.html">chat</a></li>
            
              <li><a href="console.js.html">console</a></li>
            
              <li><a href="cursor.js.html">cursor</a></li>
            
              <li><a href="elementFinder.js.html">elementFinder</a></li>
            
              <li><a href="eventMaker.js.html">eventMaker</a></li>
            
              <li><a href="forms.js.html">forms</a></li>
            
              <li><a href="jqueryPlugins.js.html">jqueryPlugins</a></li>
            
              <li><a href="linkify.js.html">linkify</a></li>
            
              <li><a href="ot.js.html">ot</a></li>
            
              <li><a href="peers.js.html">peers</a></li>
            
              <li><a href="playback.js.html">playback</a></li>
            
              <li><a href="randomutil.js.html">randomutil</a></li>
            
              <li><a href="recorder.js.html">recorder</a></li>
            
              <li><a href="session.js.html">session</a></li>
            
              <li><a href="startup.js.html">startup</a></li>
            
              <li><a href="storage.js.html">storage</a></li>
            
              <li><a href="templates-localized.js.html">templates-localized</a></li>
            
              <li><a href="templates.js.html">templates</a></li>
            
              <li><a href="templating.js.html">templating</a></li>
            
              <li><a href="togetherjs.js.html">togetherjs</a></li>
            
              <li><a href="ui.js.html">ui</a></li>
            
              <li><a href="util.js.html">util</a></li>
            
              <li><a href="videos.js.html">videos</a></li>
            
              <li><a href="visibilityApi.js.html">visibilityApi</a></li>
            
              <li><a href="walkthrough.js.html">walkthrough</a></li>
            
              <li><a href="webrtc.js.html">webrtc</a></li>
            
              <li><a href="who.js.html">who</a></li>
            
              <li><a href="windowing.js.html">windowing</a></li>
            
              <li><a href="youtubeVideos.js.html">youtubeVideos</a></li>
            
          </ul>
        </div>
      </div>

      <div class="col-md-9" id="source-content">
        <h1>youtubeVideos.js</h1>
        
          <h4><p>Support for the YouTube video sync feature</p>
</h4>
        

        <div class="small"><a href="https://github.com/mozilla/togetherjs/blob/develop/togetherjs/youtubeVideos.js">See this file on Github</a></div>

        <ul class="sections">
          
            <li id="section-0">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-0">&#182;</a>
                </div>
                
              </div>
              
                <div class="content"><div class='highlight'><pre><span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http:// mozilla.org/MPL/2.0/. */</span>

define([<span class="string">"jquery"</span>, <span class="string">"util"</span>, <span class="string">"session"</span>, <span class="string">"elementFinder"</span>],
<span class="function"><span class="keyword">function</span> <span class="params">($, util, session, elementFinder)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-1">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-1">&#182;</a>
                </div>
                <p>constant var to indicate whether two players are too far apart in sync</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> TOO_FAR_APART = <span class="number">3000</span>;</pre></div></div>
              
            </li>
          
            <li id="section-2">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-2">&#182;</a>
                </div>
                <p>embedded youtube iframes</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> youTubeIframes = [];</pre></div></div>
              
            </li>
          
            <li id="section-3">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-3">&#182;</a>
                </div>
                <p>youtube API load delay</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> API_LOADING_DELAY = <span class="number">2000</span>;

  session.on(<span class="string">"reinitialize"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">if</span> (TogetherJS.config.get(<span class="string">"youtube"</span>)) {
      prepareYouTube();
    }
  });

  session.on(<span class="string">"close"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    $(youTubeIframes).each(<span class="function"><span class="keyword">function</span> <span class="params">(i, iframe)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-4">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-4">&#182;</a>
                </div>
                <p>detach players from iframes</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(iframe).removeData(<span class="string">"togetherjs-player"</span>);
      $(iframe).removeData(<span class="string">"dontPublish"</span>);
      $(iframe).removeData(<span class="string">"currentVideoId"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-5">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-5">&#182;</a>
                </div>
                <p>disable iframeAPI</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(iframe).removeAttr(<span class="string">"enablejsapi"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-6">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-6">&#182;</a>
                </div>
                <p>remove unique youtube iframe indicators</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> id = $(iframe).attr(<span class="string">"id"</span>) || <span class="string">""</span>;
      <span class="keyword">if</span> (id.indexOf(<span class="string">"youtube-player"</span>) === <span class="number">0</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-7">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-7">&#182;</a>
                </div>
                <p>An id we added</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        $(iframe).removeAttr(<span class="string">"id"</span>);
      }
      youTubeIframes = [];
    });
  });

  $(<span class="keyword">function</span>() {
    TogetherJS.config.track(<span class="string">"youtube"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(track, previous)</span> {</span>
      <span class="keyword">if</span> (track &amp;&amp; ! previous) {
        prepareYouTube();</pre></div></div>
              
            </li>
          
            <li id="section-8">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-8">&#182;</a>
                </div>
                <p>You can enable youtube dynamically, but can’t turn it off:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        TogetherJS.config.close(<span class="string">"youtube"</span>);
      }
    });
  });

  <span class="keyword">var</span> youtubeHooked = <span class="literal">false</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">prepareYouTube</span><span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-9">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-9">&#182;</a>
                </div>
                <p>setup iframes first</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    setupYouTubeIframes();</pre></div></div>
              
            </li>
          
            <li id="section-10">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-10">&#182;</a>
                </div>
                <p>this function should be global so it can be called when API is loaded</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (!youtubeHooked) {
      youtubeHooked = <span class="literal">true</span>;
      window.onYouTubeIframeAPIReady = (<span class="keyword">function</span>(oldf) {
        <span class="keyword">return</span> <span class="keyword">function</span>() {</pre></div></div>
              
            </li>
          
            <li id="section-11">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-11">&#182;</a>
                </div>
                <p>YouTube API is ready</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>          $(youTubeIframes).each(<span class="function"><span class="keyword">function</span> <span class="params">(i, iframe)</span> {</span>
            <span class="keyword">var</span> player = <span class="keyword">new</span> YT.Player(iframe.id, { <span class="comment">// get the reference to the already existing iframe</span>
              events: {
                <span class="string">'onReady'</span>: insertPlayer,
                <span class="string">'onStateChange'</span>: publishPlayerStateChange
              }
            });
          });
          <span class="keyword">if</span> (oldf) {
            <span class="keyword">return</span> oldf();
          }
        };
      })(window.onYouTubeIframeAPIReady);
    }

    <span class="keyword">if</span> (window.YT === <span class="literal">undefined</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-12">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-12">&#182;</a>
                </div>
                <p>load necessary API
it calls onYouTubeIframeAPIReady automatically when the API finishes loading</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> tag = document.createElement(<span class="string">'script'</span>);
      tag.src = <span class="string">"https://www.youtube.com/iframe_api"</span>;
      <span class="keyword">var</span> firstScriptTag = document.getElementsByTagName(<span class="string">'script'</span>)[<span class="number">0</span>];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    } <span class="keyword">else</span> {</pre></div></div>
              
            </li>
          
            <li id="section-13">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-13">&#182;</a>
                </div>
                <p>manually invoke APIReady function when the API was already loaded by user</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      onYouTubeIframeAPIReady();
    }</pre></div></div>
              
            </li>
          
            <li id="section-14">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-14">&#182;</a>
                </div>
                <p>give each youtube iframe a unique id and set its enablejsapi param to true</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="function"><span class="keyword">function</span> <span class="title">setupYouTubeIframes</span><span class="params">()</span> {</span>
      <span class="keyword">var</span> iframes = $(<span class="string">'iframe'</span>);
      iframes.each(<span class="function"><span class="keyword">function</span> <span class="params">(i, iframe)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-15">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-15">&#182;</a>
                </div>
                <p>if the iframe’s unique id is already set, skip it
FIXME: what if the user manually sets an iframe’s id (i.e. “#my-youtube”)?
maybe we should set iframes everytime togetherjs is reinitialized?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> osrc = $(iframe).attr(<span class="string">"src"</span>), src = osrc;
        <span class="keyword">if</span> ((src || <span class="string">""</span>).indexOf(<span class="string">"youtube"</span>) != -<span class="number">1</span> &amp;&amp; !$(iframe).attr(<span class="string">"id"</span>)) {
          $(iframe).attr(<span class="string">"id"</span>, <span class="string">"youtube-player"</span>+i);
          $(iframe).attr(<span class="string">"enablejsapi"</span>, <span class="number">1</span>);</pre></div></div>
              
            </li>
          
            <li id="section-16">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-16">&#182;</a>
                </div>
                <p>we also need to add ?enablejsapi to the iframe src.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> (!<span class="regexp">/[?&amp;]enablejsapi=1(&amp;|$)/</span>.test(src)) {
            src += (<span class="regexp">/[?]/</span>.test(src)) ? <span class="string">'&amp;'</span> : <span class="string">'?'</span>;
            src += <span class="string">'enablejsapi=1'</span>;
          }</pre></div></div>
              
            </li>
          
            <li id="section-17">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-17">&#182;</a>
                </div>
                <p>the youtube API seems to be unhappy unless the URL starts
with https</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> (!<span class="regexp">/^https[:]\/\//</span>.test(src)) {
            src = <span class="string">'https://'</span> + src.replace(<span class="regexp">/^(\w+[:])?\/\//</span>, <span class="string">''</span>);
          }
          <span class="keyword">if</span> (src !== osrc) {
            $(iframe).attr(<span class="string">"src"</span>, src);
          }
          youTubeIframes[i] = iframe;
        }
      });
    } <span class="comment">// iframes are ready</span>

    <span class="function"><span class="keyword">function</span> <span class="title">insertPlayer</span><span class="params">(event)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-18">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-18">&#182;</a>
                </div>
                <p>only when it is READY, attach a player to its iframe</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> currentPlayer = event.target;
      <span class="keyword">var</span> currentIframe = currentPlayer.getIframe();</pre></div></div>
              
            </li>
          
            <li id="section-19">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-19">&#182;</a>
                </div>
                <p>check if a player is already attached in case of being reinitialized</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (!$(currentIframe).data(<span class="string">"togetherjs-player"</span>)) {
        $(currentIframe).data(<span class="string">"togetherjs-player"</span>, currentPlayer);</pre></div></div>
              
            </li>
          
            <li id="section-20">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-20">&#182;</a>
                </div>
                <p>initialize its dontPublish flag as well</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        $(currentIframe).data(<span class="string">"dontPublish"</span>, <span class="literal">false</span>);</pre></div></div>
              
            </li>
          
            <li id="section-21">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-21">&#182;</a>
                </div>
                <p>store its current video’s id</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> currentVideoId = getVideoIdFromUrl(currentPlayer.getVideoUrl());
        $(currentIframe).data(<span class="string">"currentVideoId"</span>, currentVideoId);
      }
    }
  } <span class="comment">// end of prepareYouTube</span>

  <span class="function"><span class="keyword">function</span> <span class="title">publishPlayerStateChange</span><span class="params">(event)</span> {</span>
    <span class="keyword">var</span> target = event.target;
    <span class="keyword">var</span> currentIframe = target.getIframe();</pre></div></div>
              
            </li>
          
            <li id="section-22">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-22">&#182;</a>
                </div>
                <p>var currentPlayer = $(currentIframe).data(“togetherjs-player”);</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> currentPlayer = target;
    <span class="keyword">var</span> currentTime = currentPlayer.getCurrentTime();</pre></div></div>
              
            </li>
          
            <li id="section-23">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-23">&#182;</a>
                </div>
                <p>var currentTime = target.k.currentTime;</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> iframeLocation = elementFinder.elementLocation(currentIframe);

    <span class="keyword">if</span> ($(currentPlayer).data(<span class="string">"seek"</span>)) {
      $(currentPlayer).removeData(<span class="string">"seek"</span>);
      <span class="keyword">return</span>;
    }</pre></div></div>
              
            </li>
          
            <li id="section-24">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-24">&#182;</a>
                </div>
                <p>do not publish if playerState was changed by other users</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> ($(currentIframe).data(<span class="string">"dontPublish"</span>)) {</pre></div></div>
              
            </li>
          
            <li id="section-25">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-25">&#182;</a>
                </div>
                <p>make it false again so it can start publishing events of its own state changes</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      $(currentIframe).data(<span class="string">"dontPublish"</span>, <span class="literal">false</span>);
      <span class="keyword">return</span>;
    }</pre></div></div>
              
            </li>
          
            <li id="section-26">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-26">&#182;</a>
                </div>
                <p>notify other people that I changed the player state</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (event.data == YT.PlayerState.PLAYING) {

      <span class="keyword">var</span> currentVideoId = isDifferentVideoLoaded(currentIframe);
      <span class="keyword">if</span> (currentVideoId) {</pre></div></div>
              
            </li>
          
            <li id="section-27">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-27">&#182;</a>
                </div>
                <p>notify that I just loaded another video</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        publishDifferentVideoLoaded(iframeLocation, currentVideoId);</pre></div></div>
              
            </li>
          
            <li id="section-28">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-28">&#182;</a>
                </div>
                <p>update current video id</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        $(currentIframe).data(<span class="string">"currentVideoId"</span>, currentVideoId);
      } <span class="keyword">else</span> {
        session.send({
          type: <span class="string">"playerStateChange"</span>,
          element: iframeLocation,
          playerState: <span class="number">1</span>,
          playerTime: currentTime
        });
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (event.data == YT.PlayerState.PAUSED) {
      session.send({
        type: <span class="string">"playerStateChange"</span>,
        element: iframeLocation,
        playerState: <span class="number">2</span>,
        playerTime: currentTime
      });
    } <span class="keyword">else</span> {</pre></div></div>
              
            </li>
          
            <li id="section-29">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-29">&#182;</a>
                </div>
                <p>do nothing when the state is buffering, cued, or ended</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span>;
    }
  }

  <span class="function"><span class="keyword">function</span> <span class="title">publishDifferentVideoLoaded</span><span class="params">(iframeLocation, videoId)</span> {</span>
    session.send({
      type: <span class="string">"differentVideoLoaded"</span>,
      videoId: videoId,
      element: iframeLocation
    });
  }

  session.hub.on(<span class="string">'playerStateChange'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">var</span> iframe = elementFinder.findElement(msg.element);
    <span class="keyword">var</span> player = $(iframe).data(<span class="string">"togetherjs-player"</span>);
    <span class="keyword">var</span> currentTime = player.getCurrentTime();
    <span class="keyword">var</span> currentState = player.getPlayerState();

    <span class="keyword">if</span> (currentState != msg.playerState) {
      $(iframe).data(<span class="string">"dontPublish"</span>, <span class="literal">true</span>);
    }

    <span class="keyword">if</span> (msg.playerState == <span class="number">1</span>) {
      player.playVideo();</pre></div></div>
              
            </li>
          
            <li id="section-30">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-30">&#182;</a>
                </div>
                <p>seekTo() updates the video’s time and plays it if it was already playing
and pauses it if it was already paused</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (areTooFarApart(currentTime, msg.playerTime)) {
        player.seekTo(msg.playerTime, <span class="literal">true</span>);
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (msg.playerState == <span class="number">2</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-31">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-31">&#182;</a>
                </div>
                <p>When YouTube videos are advanced while playing,
Chrome: pause -&gt; pause -&gt; play (onStateChange is called even when it is from pause to pause)
FireFox: buffering -&gt; play -&gt; buffering -&gt; play
We must prevent advanced videos from going out of sync</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      player.pauseVideo();
      <span class="keyword">if</span> (areTooFarApart(currentTime, msg.playerTime)) {</pre></div></div>
              
            </li>
          
            <li id="section-32">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-32">&#182;</a>
                </div>
                <p>“seek” flag will help supress publishing unwanted state changes</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        $(player).data(<span class="string">"seek"</span>, <span class="literal">true</span>);
        player.seekTo(msg.playerTime, <span class="literal">true</span>);
      }
    }
  });</pre></div></div>
              
            </li>
          
            <li id="section-33">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-33">&#182;</a>
                </div>
                <p>if a late user joins a channel, synchronize his videos</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  session.hub.on(<span class="string">'hello'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-34">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-34">&#182;</a>
                </div>
                <p>wait a couple seconds to make sure the late user has finished loading API</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    setTimeout(synchronizeVideosOfLateGuest, API_LOADING_DELAY);
  });

  session.hub.on(<span class="string">'synchronizeVideosOfLateGuest'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-35">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-35">&#182;</a>
                </div>
                <p>XXX can this message arrive before we’re initialized?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> iframe = elementFinder.findElement(msg.element);
    <span class="keyword">var</span> player = $(iframe).data(<span class="string">"togetherjs-player"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-36">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-36">&#182;</a>
                </div>
                <p>check if another video had been loaded to an existing iframe before I joined</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> currentVideoId = getVideoIdFromUrl(player.getVideoUrl());
    <span class="keyword">if</span> (msg.videoId != currentVideoId) {
      $(iframe).data(<span class="string">"currentVideoId"</span>, msg.videoId);
      player.loadVideoById(msg.videoId, msg.playerTime, <span class="string">'default'</span>);
    } <span class="keyword">else</span> {</pre></div></div>
              
            </li>
          
            <li id="section-37">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-37">&#182;</a>
                </div>
                <p>if the video is only cued, I do not have to do anything to sync</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (msg.playerState != <span class="number">5</span>) {
        player.seekTo(msg.playerTime, <span class="literal">true</span>).playVideo();
      }
    }
  });

  session.hub.on(<span class="string">'differentVideoLoaded'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-38">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-38">&#182;</a>
                </div>
                <p>load a new video if the host has loaded one</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> iframe = elementFinder.findElement(msg.element);
    <span class="keyword">var</span> player = $(iframe).data(<span class="string">"togetherjs-player"</span>);
    player.loadVideoById(msg.videoId, <span class="number">0</span>, <span class="string">'default'</span>);
    $(iframe).data(<span class="string">"currentVideoId"</span>, msg.videoId);

  });

  <span class="function"><span class="keyword">function</span> <span class="title">synchronizeVideosOfLateGuest</span><span class="params">()</span> {</span>
    youTubeIframes.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(iframe)</span> {</span>
      <span class="keyword">var</span> currentPlayer = $(iframe).data(<span class="string">"togetherjs-player"</span>);
      <span class="keyword">var</span> currentVideoId = getVideoIdFromUrl(currentPlayer.getVideoUrl());
      <span class="keyword">var</span> currentState = currentPlayer.getPlayerState();
      <span class="keyword">var</span> currentTime = currentPlayer.getCurrentTime();
      <span class="keyword">var</span> iframeLocation = elementFinder.elementLocation(iframe);
      session.send({
        type: <span class="string">"synchronizeVideosOfLateGuest"</span>,
        element: iframeLocation,
        videoId: currentVideoId,
        playerState: currentState, <span class="comment">//this might be necessary later</span>
        playerTime: currentTime
      });
    });
  }

  <span class="function"><span class="keyword">function</span> <span class="title">isDifferentVideoLoaded</span><span class="params">(iframe)</span> {</span>
    <span class="keyword">var</span> lastVideoId = $(iframe).data(<span class="string">"currentVideoId"</span>);
    <span class="keyword">var</span> currentPlayer = $(iframe).data(<span class="string">"togetherjs-player"</span>);
    <span class="keyword">var</span> currentVideoId = getVideoIdFromUrl(currentPlayer.getVideoUrl());</pre></div></div>
              
            </li>
          
            <li id="section-39">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-39">&#182;</a>
                </div>
                <p>since url forms of iframe src and player’s video url are different,
I have to compare the video ids</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (currentVideoId != lastVideoId) {
      <span class="keyword">return</span> currentVideoId;
    } <span class="keyword">else</span> {
      <span class="keyword">return</span> <span class="literal">false</span>;
    }
  }</pre></div></div>
              
            </li>
          
            <li id="section-40">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-40">&#182;</a>
                </div>
                <p>parses videoId from the url returned by getVideoUrl function</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="function"><span class="keyword">function</span> <span class="title">getVideoIdFromUrl</span><span class="params">(videoUrl)</span> {</span>
    <span class="keyword">var</span> videoId = videoUrl.split(<span class="string">'v='</span>)[<span class="number">1</span>];</pre></div></div>
              
            </li>
          
            <li id="section-41">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-41">&#182;</a>
                </div>
                <p>Chrome and Firefox have different positions for parameters</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> ampersandIndex = videoId.indexOf(<span class="string">'&amp;'</span>);
    <span class="keyword">if</span> (ampersandIndex != -<span class="number">1</span>) {
      videoId = videoId.substring(<span class="number">0</span>, ampersandIndex);
    }
    <span class="keyword">return</span> videoId;
  }

  <span class="function"><span class="keyword">function</span> <span class="title">areTooFarApart</span><span class="params">(myTime, theirTime)</span> {</span>
    <span class="keyword">var</span> secDiff = Math.abs(myTime - theirTime);
    <span class="keyword">var</span> milliDiff = secDiff * <span class="number">1000</span>;
    <span class="keyword">return</span> milliDiff &gt; TOO_FAR_APART;
  }
});</pre></div></div>
              
            </li>
          
        </ul>
      </div>
    </section>






        <hr>

        <footer>

          <section class="row" id="footer">
            <div class="col-xs-12 col-sm-3 text-left">
              <p><a href="https://mozillalabs.com/en-US/" target="_blank"><img src="../images/footer-mozilla-labs.png"></a></p>
            </div>
            <div class="col-xs-12 col-sm-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href=".././" class="">Overview</a></li>
                <li><a href=".././docs/" target="_blank">Docs</a></li>
                <li class=""><a href="https://github.com/mozilla/togetherjs" target="_blank">GitHub</a></li>
                <li class=""><a href="mailto:togetherjs@mozilla.com" target="_blank">Contact</a></li>
              </ul>
            </div>
            <div class="col-xs-12 col-sm-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href="https://mozillalabs.com/en-US/togetherjs/" target="_blank">About</a></li>
                <li><a href=".././docs/contributing.html">Contributing</a></li>
                <li><a href="../source/">Source Code</a></li>
                <li><a href="../faq.html">FAQ</a></li>
                <li class=""><a href="https://twitter.com/togetherjs" target="_blank">Twitter</a></li>
              </ul>
            </div>
            <div class="col-xs-12 col-sm-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href="https://www.mozilla.org/privacy/websites/" target="_blank">Privacy Policy</a></li>
                <li class=""><a href="https://www.mozilla.org/about/legal/" target="_blank">Legal Notices</a></li>
                <li class=""><a href="https://www.mozilla.org/legal/fraud-report/" target="_blank">Report Trademark Abuses</a></li>
                <li class="ph-credit">Thanks to Yuan Wang for the cover photo!</li>
              </ul>
            </div>
          </section>
        </footer>
      </section>

    </div> <!-- /container -->

  </body>
</html>
